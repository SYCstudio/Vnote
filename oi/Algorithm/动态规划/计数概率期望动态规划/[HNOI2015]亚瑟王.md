# [HNOI2015]亚瑟王
[BZOJ4008 Luogu3239]

小 K 不慎被 LL 邪教洗脑了，洗脑程度深到他甚至想要从亚瑟王邪教中脱坑。他决定，在脱坑之前，最后再来打一盘亚瑟王。既然是最后一战，就一定要打得漂亮。众所周知，亚瑟王是一个看脸的游戏，技能的发动都是看概率的。  
作为一个非洲人，同时作为一个前 OIer，小 K 自然是希望最大化造成伤害的期望值。但他已经多年没写过代码，连 Spaly都敲不对了，因此，希望你能帮帮小 K，让他感受一下当欧洲人是怎样的体验。  
本题中我们将考虑游戏的一个简化版模型。 玩家有一套卡牌，共 n张。游戏时，玩家将 n 张卡牌排列成某种顺序，排列后将卡牌按从前往后依次编号为 1 ~ n。本题中，顺序已经确定，即为输入的顺序。每张卡牌都有一个技能。第 i 张卡牌的技能发动概率为 pi，如果成功发动，则会对敌方造成di点伤害。也只有通过发动技能，卡牌才能对敌方造成伤害。基于现实因素以及小K非洲血统的考虑，pi不会为 0，也不会为 1，即 0 < pi < 1。 一局游戏一共有 r 轮。在每一轮中，系统将从第一张卡牌开始，按照顺序依次考虑每张卡牌。在一轮中，对于依次考虑的每一张卡牌：  
1如果这张卡牌在这一局游戏中已经发动过技能，则  
1.1 如果这张卡牌不是最后一张，则跳过之（考虑下一张卡牌）； 否则（是最后一张），结束这一轮游戏。  
2否则（这张卡牌在这一局游戏中没有发动过技能），设这张卡牌为第 i 张  
2.1将其以 pi的概率发动技能。  
2.2如果技能发动，则对敌方造成 di点伤害，并结束这一轮。  
2.3如果这张卡牌已经是最后一张（即 i 等于n），则结束这一轮；否则，考虑下一张卡牌。  
请帮助小 K 求出这一套卡牌在一局游戏中能造成的伤害的期望值。

设 F[i][j] 表示给 [i..n] 张牌 j 次机会的概率，则有转移

$$F[i][j]=F[i-1][j](1-P[i-1])^j+F[i-1][j+1](1-(1-P[i-1])^{j+1})$$

其中前面一项表示 j-1 不发动，后面一项表示 j-1 发动。那么第 i 张牌发动的几率就是 $F[i][j]\times (1-(1-P[i])^j)$，对应给答案期望的贡献就再乘以一个 D[i] 。

```cpp
#include<cstdio>
#include<cstdlib>
#include<cstring>
#include<algorithm>
#include<iostream>
using namespace std;

#define ld long double
#define mem(Arr,x) memset(Arr,x,sizeof(Arr))

const int maxN=230;
const int maxR=140;

int n,R,D[maxN];
ld P[maxN][maxR],F[maxN][maxR];

int main(){
    int Case;scanf("%d",&Case);
    while (Case--){
	mem(P,0);mem(F,0);
	scanf("%d%d",&n,&R);
	for (int i=1;i<=n;i++) scanf("%LF%d",&P[i][1],&D[i]);
	for (int i=0;i<=n;i++){
	    P[i][0]=1;P[i][1]=1.0-P[i][1];
	    for (int j=2;j<=R+5;j++) P[i][j]=P[i][j-1]*P[i][1];
	}
	ld Ans=0;
	F[0][R]=1;
	for (int i=1;i<=n;i++)
	    for (int j=1;j<=R;j++){
		F[i][j]=F[i-1][j]*P[i-1][j]+F[i-1][j+1]*(1-P[i-1][j+1]);
		Ans+=F[i][j]*(1-P[i][j])*D[i];
	    }
	
	printf("%.10LF\n",Ans);
    }
    return 0;
}
```